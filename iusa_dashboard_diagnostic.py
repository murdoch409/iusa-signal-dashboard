<entire code from previous message pasted here for brevity>